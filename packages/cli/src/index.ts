import { program } from 'commander'
import { InitHandler } from './commands/init/init.handler.js'
import { InitPrompt } from './commands/init/init.prompt.js'
import { ConfigService } from './services/config.service.js'

function formatError(error: unknown): string {
  if (error instanceof Error) {
    return error.message
  }
  if (typeof error === 'string') {
    return error
  }
  return 'An unexpected error occurred'
}

program.name('pipes').description('Subsquid Pipes CLI').version('0.1.0')

const initCommand = program
  .command('init')
  .description('Initialize a new pipe project')

initCommand
  .option('--config <json>', 'JSON configuration string to skip prompts')
  .action(async (options) => {
    try {
      if (options.config) {
        const handler = InitHandler.fromJson(options.config)
        await handler.handle()
      } else {
        const initConfig = new InitPrompt()
        await initConfig.run()
      }
    } catch (error) {
      console.error(`\n❌ Error: ${formatError(error)}`)
      process.exit(1)
    }
  })

initCommand
  .option('--config-id <id>', 'Use the config ID generated by the Pipes Starter UI')
  .action(async (options) => {
    try {
      const configService = new ConfigService()
      const config = await configService.getConfigJsonByHash(options.configId)
      const handler = InitHandler.fromJson(config)
      await handler.handle()
    } catch (error) {
      console.error(`\n❌ Error: ${formatError(error)}`)
      process.exit(1)
    }
  })

try {
  program.parse()
} catch (error) {
  console.error(`\n❌ Error: ${formatError(error)}`)
  process.exit(1)
}
